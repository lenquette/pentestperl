#!/usr/bin/perl



print "Please chose one of the following: \n";
print "\t1. scan a network\n";
print "\t2. scan a host\n";
print "\t3. scan a website\n";
chomp($choice=<STDIN>);


## Check the existence of the output filename 

print "Please enter the output file name\n";
chomp($output_filename=<STDIN>);
while(-e "$output_filename" && $output_choice!=2) {
	print "WARNING: the file \"$output_filename\" already exist ! \n"; 
	do {
		print "Please choose: \n\t (1)- To choose another name \n\t (2)- To continue and overwrite $output_filename\n";
		chomp($output_choice=<STDIN>);
		if($output_choice == 1) {
			print "Please enter the output filename \n";
			chomp($output_filename=<STDIN>);		
		} elsif ($output_choice !=2) {
			print "Wrong choice !, Please chose 1 or 2 \n";
		} 
	} while ($output_choice!=1 &&  $output_choice!=2 );
}



# scanning a network 

if ($choice == 1) {
	print "Please Enter the network IP ex: 192.168.1.0/24\n";
	chomp($network_ip=<STDIN>);
	open ($input, "nmap -sP $network_ip |") || die "could not run nmap\n";
	open(HANDLE, "> $output_filename") || die "could not open the file\n";

	while (<$input>) {
		chomp($line=<$input>);
		if ($line=~/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/) {
			$ip1=$1;
		}
		if ($line =~ m/Nmap scan report for ([^\s]+)/) {
			$name1=$1;
		}
		$machines{"$ip1"} = "$name1";
	}

	print HANDLE "==================== Network Scan Result =======================\n";
	print HANDLE "IP address\t Machine name\n";
	foreach $item (keys %machines) {
        	print HANDLE "$item \t $machines{$item} \n";
	}	

	#Scan each addresse IP found in the network scanning
	foreach $item (keys %machines) {
		print "Start scanning the machine: $item\n";	
		@scan=`nmap -T4 -p- $item`;
		#print "finished scanning the machine $item\n";
		#print @scan;
		#open($input, "nmap -T4 -p- $item |") || die "couldn't scan $itemi\n";
		print HANDLE "\n ============ Scanning the machine $item =====================\n";
		print HANDLE "Port \t tcp/udp \t Status\n";
		
		#while(<$input>) {
		foreach $line (@scan) {
			chomp($line);
			if ($line=~/([0-9]*)\/((?:tcp|udp))\s+([^\s]+)/) {
				print HANDLE "$1 \t $2 \t\t $3\n";
				push(@ports, "$1");
			}
		}
		$open_ports = join(",",@ports);
		print "Open ports for $item are: $open_ports \n";


        	print HANDLE "\n=================== More information about the opened ports ===================== \n\n";
        	########## NMAP WITH -A option
        	# Here we write into the file, more information about the opened ports that we gathered using "-A" option
        	@scan2 = `nmap -T4 -p $open_ports -A $item`;
        	foreach $line (@scan2) {
                	unless ($line=~/(^Starting|Nmap|Host|Service)/) {    # Delete all the lines that we don't need
                        	print HANDLE "$line\n";
                	}
        	}

		print "Scan of the machine : $item finished\n";
		undef(@ports);
	}
} elsif ($choice == 2) { ##~############################################################################# Current working in this section 
	
	# IN this section we ran first nmap -p- to detect all opened ports and the we run it again with the option -A
	# We do so to make the resulat as fast as we can
	
	open(HANDLE, "> $output_filename") || die "could not open the file\n";
	print "Please enter the IP address. Ex: 192.168.1.1 \n";
	chomp($ip_host=<STDIN>);
	print "Start scanning the machine: $ip_host\n";
	@scan=`nmap -T4 -p- $ip_host`;
	print "finished scanning the machine $ip_host\n";
	print HANDLE "\n ============ Scanning the machine $ip_host =====================\n";
	print HANDLE "Port \t tcp/udp \t Status\n";
	
	# make all the opened ports in one array ($ports) and then join them in one string separated by "," ($open_ports) to use them with nmap -A options
	#foreach $line (@scan) {
		#  chomp($line);
		# if ($line=~/([0-9]*)\/((?:tcp|udp))\s+([^\s]+)/) {
			# push(@ports,"$1");
			#  }
		# }
	# $open_ports = join(",",@ports);


	#print "Open ports are :################  $open_ports \n";


	# we write first in the file the information about the ports opened
	foreach $line (@scan) {
		chomp($line);
                if ($line=~/([0-9]*)\/((?:tcp|udp))\s+([^\s]+)/) {
                	print HANDLE "$1 \t $2 \t\t $3\n";
			push(@ports, "$1");
                }
	}
	$open_ports = join(",",@ports);

	print "Open ports are :################  $open_ports \n";

	print HANDLE "\n=================== More information about the opened ports ===================== \n\n";
	########## NMAP WITH -A option
	# Here we write into the file, more information about the opened ports that we gathered using "-A" option
	@scan = `nmap -T4 -p $open_ports -A $ip_host`;
	foreach $line (@scan) {
		unless ($line=~/(^Starting|Nmap|Host|Service)/) {    # Delete all the lines that we don't need
			print HANDLE "$line\n";
		}
	}

} elsif ($choice == 3) {
	print "Please Enter the url: ";
        chomp($url=<STDIN>);
	open(HANDLE, "> $output_filename") || die "could not open the file\n";
	print HANDLE " \t ======================== Scanning $url result =======================\n";
	print "start scanning \"$url\" \n";
	@scan=`nikto -h $url`;
	print "Finish scanning of $url";
	foreach $item (@scan) {
		print HANDLE "$item\n";
	}
}	

print "
 ================================================================
#	       	    Scan Finished				#
# 	Your result will be in a file: $output_filename		#
 ===============================================================\n";


close $input;
close HANDLE;
