#!/usr/bin/perl



print "Please chose one of the following: \n";
print "\t1. scan a network\n";
print "\t2. scan a host\n";
chomp($choice=<STDIN>);


## Check the existence of the output filename 

print "Please enter the output file name\n";
chomp($output_filename=<STDIN>);
while(-e "$output_filename" && $output_choice!=2) {
	print "WARNING: the file \"$output_filename\" already exist ! \n"; 
	do {
		print "Please choose: \n\t (1)- To choose another name \n\t (2)- To continue and overwrite $output_filename\n";
		chomp($output_choice=<STDIN>);
		if($output_choice == 1) {
			print "Please enter the output filename \n";
			chomp($output_filename=<STDIN>);		
		} elsif ($output_choice !=2) {
			print "Wrong choice !, Please chose 1 or 2 \n";
		} 
	} while ($output_choice!=1 &&  $output_choice!=2 );
}



# scanning a network 

if ($choice == 1) {
	print "Please Enter the network IP ex: 192.168.1.0/24\n";
	chomp($network_ip=<STDIN>);
	open ($input, "nmap -sP $network_ip |") || die "could not run nmap\n";
	open(HANDLE, "> $output_filename") || die "could not open the file\n";

	while (<$input>) {
		chomp($line=<$input>);
		if ($line=~/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/) {
			$ip1=$1;
		}
		if ($line =~ m/Nmap scan report for ([^\s]+)/) {
			$name1=$1;
		}
		$machines{"$ip1"} = "$name1";
	}

	print HANDLE "==================== Network Scan Result =======================\n";
	print HANDLE "IP address\t Machine name\n";
	foreach $item (keys %machines) {
        	print HANDLE "$item \t $machines{$item} \n";
	}	

	#Scan each addresse IP found in the network scanning
	foreach $item (keys %machines) {
		print "Start scanning the machine: $item\n";	
		@scan=`nmap -T4 -p- $item`;
		print "finished scanning the machine $item\n";
		#print @scan;
		#open($input, "nmap -T4 -p- $item |") || die "couldn't scan $itemi\n";
		print HANDLE "\n ============ Scanning the machine $item =====================\n";
		print HANDLE "Port \t tcp/udp \t Status\n";
		
		#while(<$input>) {
		foreach $line (@scan) {
			chomp($line);
			if ($line=~/([0-9]*)\/((?:tcp|udp))\s+([^\s]+)/) {
				print HANDLE "$1 \t $2 \t\t $3\n";
			}
		}
		print "Scan of the machine : $item finished\n";
	}
}	

print "
 ================================================================
#	       	    Scan Finished				#
# 	Your result will be in a file: $output_filename		#
 ===============================================================\n";


close $input;
close HANDLE;
